{"version":3,"sources":["api/record/record.controller.js"],"names":[],"mappings":"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","file":"api/record/record.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/records              ->  index\n * POST    /api/records              ->  create\n * GET     /api/records/:id          ->  show\n * PUT     /api/records/:id          ->  update\n * DELETE  /api/records/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport Record from './record.model';\nimport q from 'q';\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction saveUpdates(updates) {\n  return function(entity) {\n    var updated = _.merge(entity, updates);\n    return updated.save()\n      .then(updated => {\n        return updated;\n      });\n  };\n}\n\nfunction removeEntity(res) {\n  return function(entity) {\n    if (entity) {\n      return entity.remove()\n        .then(() => {\n          res.status(204).end();\n        });\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if (!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nfunction checkParam(param, dataType) {\n\n  if(param === null){ return false; }\n  var response = false;\n\n  if(dataType === 'number'){\n    console.log('chequea numero')\n    if(typeof param === 'number'){\n      response = true;\n    }\n    if(typeof param === 'string'){\n      \n      if(/^\\d*$/.test( param )){\n        console.log('es  numero')\n        response = true;\n      }\n    }\n  }\n\n  if(dataType === 'objectId'){\n    if(/^[0-9a-f]{24}$/i.test(param)){\n      response = true;\n    }\n  }\n\n  //filtro de registros\n  if (dataType === 'filter') {\n    //checkeando si hay errores en el parseo a JSON\n    try {\n      var arr = JSON.parse(param);\n      //check if is an Array and if is empty\n      if(arr.length){\n        // verificando si los obj dentro del array tiene las propiedades key, datatype y value\n        var isValid = true;\n        for (var index = 0; index < arr.length; index++) {\n          if(arr[index].key === null || arr[index].value === null || arr[index].datatype === null){\n            isValid = false;\n          }\n        }\n        response = isValid;\n      }\n\n    } catch (err) {\n      response = false;\n      console.log('invalid JSON')\n    }\n  }\n\n  return response;\n}\n\n// Gets a list of Records\nexport function index(req, res) {\n\n  var items = req.query.items || 30;\n  var page = req.query.page || 1;\n  // checking the query data types\n  if(!checkParam(page, 'number') || page === \"0\" ){\n    return respondWithResult(res, 500)({Error:'El par치metro page no es v치lido'});\n  }\n  if(!checkParam(items, 'number') ){\n    return respondWithResult(res, 500)({Error:'El par치metro items no es v치lido'});\n  }\n  \n  var query = {};\n  //filtrar por schm\n  if(checkParam(req.query.schm, 'objectId')){\n    query.schm = req.query.schm;\n    //console.log('schm')\n  }\n\n  if(checkParam(req.query.filter, 'filter')){\n    query[\"$and\"] = [];\n    \n    var filter = JSON.parse(req.query.filter);\n    for (var i = 0; i < filter.length; i++) {\n      var p = {attributes:{}};\n      p[\"attributes\"][\"$elemMatch\"] = {};\n      p[\"attributes\"][\"$elemMatch\"]['id'] = filter[i].key;\n      p[\"attributes\"][\"$elemMatch\"][filter[i].datatype] = filter[i].value;\n      query[\"$and\"].push(p);\n    }\n    console.log(filter);\n  }\n\n\n  q.all([\n    Record.find(query).count().exec(),\n    Record.find(query).skip(items*(page-1)).limit(items)\n  ]).spread( (count, data) =>{\n    respondWithResult(res)({\n        page:parseInt(page),\n        pages:Math.ceil(count/items),\n        length: data.length,\n        totalLength: count,\n        items:data\n      });\n  }).fail(handleError(res));\n}\n\n// Gets a single Record from the DB\nexport function show(req, res) {\n  return Record.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Creates a new Record in the DB\nexport function create(req, res) {\n  return Record.create(req.body)\n    .then(respondWithResult(res, 201))\n    .catch(handleError(res));\n}\n\n// Updates an existing Record in the DB\nexport function update(req, res) {\n  if (req.body._id) {\n    delete req.body._id;\n  }\n  return Record.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(saveUpdates(req.body))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Deletes a Record from the DB\nexport function destroy(req, res) {\n  return Record.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n}\n"],"sourceRoot":"/source/"}